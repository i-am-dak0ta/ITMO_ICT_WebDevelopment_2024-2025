# Управление бронированиями

### Описание

Эндпоинт позволяет создавать новые бронирования или обновлять существующие.

---

### URL

- Создание бронирования: `POST /reservation`
- Обновление бронирования: `PATCH /reservation/<reservation_id>`

---

## Создание бронирования

### Параметры запроса

Запрос принимает JSON-объект в теле запроса.

| Параметр          | Тип данных    | Обязательный | Описание                                                                 |
|--------------------|---------------|--------------|--------------------------------------------------------------------------|
| `passport_number`  | `string`      | Да           | Номер паспорта клиента (уникальный).                                     |
| `first_name`       | `string`      | Да           | Имя клиента.                                                             |
| `last_name`        | `string`      | Да           | Фамилия клиента.                                                         |
| `middle_name`      | `string/null` | Нет          | Отчество клиента.                                                        |
| `city_from`        | `string`      | Да           | Город, из которого прибыл клиент.                                        |
| `room_number`      | `integer`     | Да           | Номер комнаты, в которую клиент заселяется.                              |
| `arrival_date`     | `string`      | Да           | Дата заселения в формате `YYYY-MM-DD`.                                   |
| `departure_date`   | `string`      | Да           | Дата выезда в формате `YYYY-MM-DD`.                                      |
| `status`           | `string`      | Нет          | Статус бронирования: `BOOKED`, `CONFIRMED`, `CHECKED_IN`, `CHECKED_OUT`, `CANCELLED`. По умолчанию: `BOOKED`. |
| `payment_status`   | `string`      | Нет          | Статус оплаты: `PREPAID`, `PAID`, `UNPAID`, `REFUNDED`. По умолчанию: `UNPAID`. |

---

### Пример запроса

```http
POST /reservation
Content-Type: application/json

{
    "passport_number": "1234567890",
    "first_name": "Иван",
    "last_name": "Петров",
    "city_from": "Москва",
    "room_number": 101,
    "arrival_date": "2024-12-10",
    "departure_date": "2024-12-15",
    "status": "CONFIRMED",
    "payment_status": "PAID"
}
```

---

### Успешный ответ (201)

```json
{
    "reservation_id": 1,
    "client_id": 10,
    "room_number": 101,
    "arrival_date": "2024-12-10",
    "departure_date": "2024-12-15",
    "status": "CONFIRMED",
    "price_at_booking": 5000
}
```

---

## Обновление бронирования

### Параметры запроса

Запрос принимает JSON-объект в теле запроса. Обновление возможно для следующих полей:

| Параметр          | Тип данных    | Обязательный | Описание                                                                 |
|--------------------|---------------|--------------|--------------------------------------------------------------------------|
| `arrival_date`     | `string`      | Нет          | Новая дата заселения в формате `YYYY-MM-DD`.                             |
| `departure_date`   | `string`      | Нет          | Новая дата выезда в формате `YYYY-MM-DD`.                                |
| `status`           | `string`      | Нет          | Новый статус бронирования: `BOOKED`, `CONFIRMED`, `CHECKED_IN`, `CHECKED_OUT`, `CANCELLED`. |
| `payment_status`   | `string`      | Нет          | Новый статус оплаты: `PREPAID`, `PAID`, `UNPAID`, `REFUNDED`.            |
| `room_number`      | `integer`     | Нет          | Новый номер комнаты для бронирования.                                    |

---

### Пример запроса

```http
PATCH /reservation/1
Content-Type: application/json

{
    "departure_date": "2024-12-20",
    "status": "CHECKED_OUT",
    "payment_status": "PAID"
}
```

---

### Успешный ответ (200)

```json
{
    "reservation_id": 1,
    "client_id": 10,
    "room_number": 101,
    "arrival_date": "2024-12-10",
    "departure_date": "2024-12-20",
    "status": "CHECKED_OUT",
    "payment_status": "PAID",
    "price_at_booking": 6000
}
```

---

## Ошибки

#### Ошибки валидации данных (422)

Пример ответа:

```json
{
    "departure_date": "Дата выезда должна быть позже даты заселения.",
    "room_number": "Комната с номером 102 недоступна для бронирования."
}
```

| Код   | Описание                                                         |
|-------|-----------------------------------------------------------------|
| 422   | Ошибки валидации данных. Например, указаны некорректные даты или недоступная комната. |

#### Бронирование не найдено (404)

Пример ответа:

```json
{
    "detail": "Бронирование с указанным ID не найдено."
}
```

---

### Примечания

- При создании бронирования, если клиент с указанным паспортом не найден, он будет автоматически создан.
- Если указанный номер комнаты уже занят, бронирование будет отклонено.
- При обновлении статуса бронирования:
  - Если статус изменен на `CHECKED_OUT`, номер переводится в состояние `REQUIRES_CLEANING`.
  - Если статус изменен на `CANCELLED`, номер становится доступным (`AVAILABLE`).
- Все даты должны быть корректными, и дата выезда должна быть позже даты заселения.